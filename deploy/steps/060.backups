#!/bin/bash

# ==============================================
# Step 060: Automated Database Backups
# ==============================================

set -e

log "Automated Database Backups"

# Define paths
APP_DIR="$HOME/gex-options-platform"
BACKUP_SCRIPT_SOURCE="$APP_DIR/deployment/database/backup-gex-db.sh"
BACKUP_SCRIPT_TARGET="/usr/local/bin/backup-gex-db.sh"
BACKUP_DIR="$HOME/backups"
PGPASS_FILE="$HOME/.pgpass"
CREDS_FILE="$HOME/.zerogex_db_creds"

# Load database credentials
if [ ! -f "$CREDS_FILE" ]; then
    log "  ✗ Database credentials file not found: $CREDS_FILE"
    log "     Run step 020.database first"
    exit 1
fi

log "  → Loading database credentials..."
source "$CREDS_FILE"

# Create .pgpass file
log "  → Creating .pgpass file for passwordless backups..."
cat > "$PGPASS_FILE" << EOF
localhost:5432:gex_db:gex_user:${DB_PASSWORD}
EOF

# Set strict permissions (required by PostgreSQL)
chmod 600 "$PGPASS_FILE"
log "     ✓ .pgpass file created with secure permissions"

# Test .pgpass works
log "  → Testing PostgreSQL connection without password..."
if pg_dump -U gex_user -h localhost gex_db | head -n 20 > /dev/null 2>&1; then
    log "     ✓ Passwordless connection works"
else
    log "     ✗ Passwordless connection failed"
    exit 1
fi

# Create backup directory
log "  → Creating backup directory..."
mkdir -p "$BACKUP_DIR"
log "     ✓ Backup directory: $BACKUP_DIR"

# Check if backup script exists in repo
if [ -f "$BACKUP_SCRIPT_SOURCE" ]; then
    log "  → Installing backup script from repository..."
    sudo cp "$BACKUP_SCRIPT_SOURCE" "$BACKUP_SCRIPT_TARGET"
    sudo chmod +x "$BACKUP_SCRIPT_TARGET"
    log "     ✓ Backup script installed: $BACKUP_SCRIPT_TARGET"
else
    log "     ✗ Backup script is not installed"
    exit 1
fi

# Test the backup script
log "  → Testing backup script..."
if sudo -u ubuntu "$BACKUP_SCRIPT_TARGET"; then
    log "     ✓ Backup test successful"
else
    log "     ✗ Backup test failed"
    exit 1
fi

# Check backup was created
log "  → Verifying backup files..."
BACKUP_COUNT=$(find "$BACKUP_DIR" -name "gex_db_*.dump" -type f | wc -l)
if [ "$BACKUP_COUNT" -gt 0 ]; then
    log "     ✓ Found $BACKUP_COUNT backup file(s)"
    ls -lh "$BACKUP_DIR"/gex_db_*.sql.gz | tail -n 3
else
    log "     ✗ No backup files found"
    exit 1
fi

# Setup automated backups via cron
log "  → Setting up automated backups (cron)..."

# Create cron job entry
CRON_JOB="0 2 * * * $BACKUP_SCRIPT_TARGET 2>&1"

# Check if cron job already exists
if crontab -l 2>/dev/null | grep -q "backup-gex-db.sh"; then
    log "     ℹ Cron job already exists, skipping..."
else
    # Add cron job
    (crontab -l 2>/dev/null; echo "# ZeroGEX Database Backup - Daily at 2:00 AM") | crontab -
    (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
    log "     ✓ Cron job added (daily at 2:00 AM)"
fi

# Display current crontab
CRON_SCHED=`crontab -l 2>/dev/null | grep -A1 "ZeroGEX" || echo "     (none found)"`
log ""
log "  Current cron schedule:"
log "  ${CRON_SCHED}"
log ""
log "Database backup configuration complete!"
log ""
log "Summary:"
log "  ✓ .pgpass file created for passwordless backups"
log "  ✓ Backup script installed: $BACKUP_SCRIPT_TARGET"
log "  ✓ Backup directory: $BACKUP_DIR"
log "  ✓ Test backup successful"
log "  ✓ Automated daily backups configured (2:00 AM)"
log "  ✓ Backup retention: 30 days"
log ""
log "Backup Configuration:"
log "  • Schedule: Daily at 2:00 AM"
log "  • Location: $BACKUP_DIR"
log "  • Format: Compressed SQL (.sql.gz)"
log "  • Retention: 30 days"
log "  • Logs: ~/logs/backup.log"
log ""
log "Manual Operations:"
log "  • Run backup now: sudo -u ubuntu $BACKUP_SCRIPT_TARGET"
log "  • View backup log: tail -f ~/logs/backup.log"
log "  • List backups: ls -lh $BACKUP_DIR"
log "  • Restore backup: gunzip -c <backup.sql.gz> | psql -U gex_user -h localhost gex_db"
log ""
