#!/bin/bash

# ==============================================
# Step 080: Deployment Validation
# ==============================================

set -e

echo "Deployment Validation"

# Define paths
CREDS_FILE="$HOME/.zerogex_db_creds"

# Load database credentials
if [ -f "$CREDS_FILE" ]; then
    source "$CREDS_FILE"
else
    echo "  ✗ Database credentials not found"
    exit 1
fi

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Validation results tracking
TOTAL_CHECKS=0
PASSED_CHECKS=0
FAILED_CHECKS=0
WARNING_CHECKS=0

# Check function
check_service() {
    TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
    local service_name=$1
    local display_name=$2

    if systemctl is-active --quiet "$service_name"; then
        echo -e "  ${GREEN}✓${NC} $display_name: $(systemctl is-active "$service_name")"
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
        return 0
    else
        echo -e "  ${RED}✗${NC} $display_name: $(systemctl is-active "$service_name")"
        FAILED_CHECKS=$((FAILED_CHECKS + 1))
        return 1
    fi
}

# Section 1: Service Status
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "1. Service Status Checks"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
check_service "gex-ingestion" "Ingestion Service"
check_service "gex-scheduler" "Scheduler Service"
check_service "postgresql" "PostgreSQL Database"
check_service "fail2ban" "fail2ban"
echo ""

# Section 2: Database Connection
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "2. Database Connection Test"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
if PGPASSWORD="$DB_PASSWORD" psql -U gex_user -d gex_db -h localhost -c "SELECT NOW();" > /dev/null 2>&1; then
    DB_TIME=$(PGPASSWORD="$DB_PASSWORD" psql -U gex_user -d gex_db -h localhost -t -c "SELECT NOW();")
    echo -e "  ${GREEN}✓${NC} Database connection successful"
    echo "     Database time: $DB_TIME"
    PASSED_CHECKS=$((PASSED_CHECKS + 1))
else
    echo -e "  ${RED}✗${NC} Database connection failed"
    FAILED_CHECKS=$((FAILED_CHECKS + 1))
fi
echo ""

# Section 3: Database Schema
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "3. Database Schema Validation"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# Check for critical tables
TABLES=("options_quotes" "latest_gex")
for table in "${TABLES[@]}"; do
    TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
    if PGPASSWORD="$DB_PASSWORD" psql -U gex_user -d gex_db -h localhost -t -c "\dt $table" 2>/dev/null | grep -q "$table"; then
        echo -e "  ${GREEN}✓${NC} Table exists: $table"
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
    else
        echo -e "  ${YELLOW}⚠${NC} Table not found: $table (may not be created yet)"
        WARNING_CHECKS=$((WARNING_CHECKS + 1))
    fi
done
echo ""

# Section 4: Recent Ingestion Logs
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "4. Ingestion Service Logs (last 10 lines)"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
sudo journalctl -u gex-ingestion -n 10 --no-pager
echo ""

# Section 5: Recent Scheduler Logs
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "5. Scheduler Service Logs (last 10 lines)"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
sudo journalctl -u gex-scheduler -n 10 --no-pager
echo ""

# Section 6: Data Flow Check
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "6. Recent Data Flow Check (last 10 minutes)"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))

# Check if options_quotes table exists first
if PGPASSWORD="$DB_PASSWORD" psql -U gex_user -d gex_db -h localhost -t -c "\dt options_quotes" 2>/dev/null | grep -q "options_quotes"; then
    DATA_CHECK=$(PGPASSWORD="$DB_PASSWORD" psql -U gex_user -d gex_db -h localhost -t -c "SELECT COUNT(*) FROM options_quotes WHERE timestamp > NOW() - INTERVAL '10 minutes';" 2>/dev/null | xargs)

    if [ -n "$DATA_CHECK" ] && [ "$DATA_CHECK" -gt 0 ]; then
        echo -e "  ${GREEN}✓${NC} Recent data found: $DATA_CHECK rows in last 10 minutes"
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
    else
        echo -e "  ${YELLOW}⚠${NC} No recent data (0 rows in last 10 minutes)"
        echo "     This is normal if services just started or markets are closed"
        WARNING_CHECKS=$((WARNING_CHECKS + 1))
    fi
else
    echo -e "  ${YELLOW}⚠${NC} options_quotes table not yet created"
    WARNING_CHECKS=$((WARNING_CHECKS + 1))
fi
echo ""

# Section 7: GEX Calculations
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "7. Latest GEX Calculations"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))

if PGPASSWORD="$DB_PASSWORD" psql -U gex_user -d gex_db -h localhost -t -c "\dt latest_gex" 2>/dev/null | grep -q "latest_gex"; then
    GEX_COUNT=$(PGPASSWORD="$DB_PASSWORD" psql -U gex_user -d gex_db -h localhost -t -c "SELECT COUNT(*) FROM latest_gex;" 2>/dev/null | xargs)

    if [ -n "$GEX_COUNT" ] && [ "$GEX_COUNT" -gt 0 ]; then
        echo -e "  ${GREEN}✓${NC} GEX calculations found: $GEX_COUNT rows"
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
        echo ""
        echo "  Sample GEX data:"
        PGPASSWORD="$DB_PASSWORD" psql -U gex_user -d gex_db -h localhost -c "SELECT * FROM latest_gex LIMIT 5;" 2>/dev/null || echo "     (no data yet)"
    else
        echo -e "  ${YELLOW}⚠${NC} No GEX calculations yet"
        echo "     This is normal if services just started"
        WARNING_CHECKS=$((WARNING_CHECKS + 1))
    fi
else
    echo -e "  ${YELLOW}⚠${NC} latest_gex table not yet created"
    WARNING_CHECKS=$((WARNING_CHECKS + 1))
fi
echo ""

# Section 8: System Resources
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "8. System Resource Usage"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# Disk usage
DISK_USAGE=$(df -h / | tail -1 | awk '{print $5}' | sed 's/%//')
DISK_INFO=$(df -h / | tail -1)
echo "  Disk Usage:"
echo "     $DISK_INFO"
if [ "$DISK_USAGE" -lt 80 ]; then
    echo -e "     ${GREEN}✓${NC} Disk usage OK (${DISK_USAGE}%)"
elif [ "$DISK_USAGE" -lt 90 ]; then
    echo -e "     ${YELLOW}⚠${NC} Disk usage warning (${DISK_USAGE}%)"
else
    echo -e "     ${RED}✗${NC} Disk usage critical (${DISK_USAGE}%)"
fi
echo ""

# Memory usage
MEM_INFO=$(free -h | grep Mem)
MEM_PERCENT=$(free | grep Mem | awk '{printf("%.0f", $3/$2 * 100)}')
echo "  Memory Usage:"
echo "     $MEM_INFO"
if [ "$MEM_PERCENT" -lt 80 ]; then
    echo -e "     ${GREEN}✓${NC} Memory usage OK (${MEM_PERCENT}%)"
elif [ "$MEM_PERCENT" -lt 90 ]; then
    echo -e "     ${YELLOW}⚠${NC} Memory usage warning (${MEM_PERCENT}%)"
else
    echo -e "     ${RED}✗${NC} Memory usage high (${MEM_PERCENT}%)"
fi
echo ""

# Section 9: Security Status
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "9. Security Configuration"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# UFW status
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
if sudo ufw status | grep -q "Status: active"; then
    echo -e "  ${GREEN}✓${NC} Firewall (UFW) is active"
    PASSED_CHECKS=$((PASSED_CHECKS + 1))
else
    echo -e "  ${RED}✗${NC} Firewall (UFW) is not active"
    FAILED_CHECKS=$((FAILED_CHECKS + 1))
fi

# SSH configuration
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
if grep -q "^PermitRootLogin no" /etc/ssh/sshd_config && grep -q "^PasswordAuthentication no" /etc/ssh/sshd_config; then
    echo -e "  ${GREEN}✓${NC} SSH hardening configured"
    PASSED_CHECKS=$((PASSED_CHECKS + 1))
else
    echo -e "  ${YELLOW}⚠${NC} SSH hardening may not be fully configured"
    WARNING_CHECKS=$((WARNING_CHECKS + 1))
fi

# Backup configuration
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
if crontab -l 2>/dev/null | grep -q "backup-gex-db.sh"; then
    echo -e "  ${GREEN}✓${NC} Automated backups configured"
    PASSED_CHECKS=$((PASSED_CHECKS + 1))
else
    echo -e "  ${YELLOW}⚠${NC} Automated backups not configured"
    WARNING_CHECKS=$((WARNING_CHECKS + 1))
fi
echo ""

# Final Summary
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "VALIDATION SUMMARY"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "Total Checks: $TOTAL_CHECKS"
echo -e "${GREEN}Passed: $PASSED_CHECKS${NC}"
echo -e "${YELLOW}Warnings: $WARNING_CHECKS${NC}"
echo -e "${RED}Failed: $FAILED_CHECKS${NC}"
echo ""

if [ "$FAILED_CHECKS" -eq 0 ]; then
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}✓ Deployment validation PASSED!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "ZeroGEX platform is ready for production!"

    if [ "$WARNING_CHECKS" -gt 0 ]; then
        echo ""
        echo -e "${YELLOW}Note: Some warnings were detected. These are typically normal"
        echo -e "for a fresh deployment or when markets are closed.${NC}"
    fi
else
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}✗ Deployment validation FAILED!${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "Please review the failed checks above and resolve issues."
    echo "Check service logs for more details:"
    echo "  sudo journalctl -u gex-ingestion -f"
    echo "  sudo journalctl -u gex-scheduler -f"
    exit 1
fi

echo ""
echo "Deployment validation complete!"
echo ""
