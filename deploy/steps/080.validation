#!/bin/bash

# ==============================================
# Step 080: Deployment Validation
# ==============================================

set -e

log "Deployment Validation"

# Define paths
CREDS_FILE="$HOME/.zerogex_db_creds"

# Load database credentials
if [ -f "$CREDS_FILE" ]; then
    source "$CREDS_FILE"
else
    log "  ✗ Database credentials not found"
    exit 1
fi

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Validation results tracking
TOTAL_CHECKS=0
PASSED_CHECKS=0
FAILED_CHECKS=0
WARNING_CHECKS=0

# Check function
check_service() {
    TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
    local service_name=$1
    local display_name=$2

    if systemctl is-active --quiet "$service_name"; then
        SYS_ACTIVE=`echo -e "  ${GREEN}✓${NC} $display_name: $(systemctl is-active "$service_name")"`
	log "${SYS_ACTIVE}"
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
        return 0
    else
        SYS_ACTIVE=`echo -e "  ${RED}✗${NC} $display_name: $(systemctl is-active "$service_name")"`
	log "${SYS_ACTIVE}"
        FAILED_CHECKS=$((FAILED_CHECKS + 1))
        return 1
    fi
}

# Section 1: Service Status
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
log "1. Service Status Checks"
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
check_service "gex-ingestion" "Ingestion Service"
check_service "gex-scheduler" "Scheduler Service"
check_service "postgresql" "PostgreSQL Database"
check_service "fail2ban" "fail2ban"
log ""

# Section 2: Database Connection
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
log "2. Database Connection Test"
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
if PGPASSWORD="$DB_PASSWORD" psql -U gex_user -d gex_db -h localhost -c "SELECT NOW();" > /dev/null 2>&1; then
    DB_TIME=$(PGPASSWORD="$DB_PASSWORD" psql -U gex_user -d gex_db -h localhost -t -c "SELECT NOW();")
    DB_CONN_OUT=`echo -e "  ${GREEN}✓${NC} Database connection successful"`
    log "${DB_CONN_OUT}"
    log "     Database time: $DB_TIME"
    PASSED_CHECKS=$((PASSED_CHECKS + 1))
else
    DB_FAIL_OUT=`echo -e "  ${RED}✗${NC} Database connection failed"`
    log "${DB_FAIL_OUT}"
    FAILED_CHECKS=$((FAILED_CHECKS + 1))
fi
log ""

# Section 3: Database Schema
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
log "3. Database Schema Validation"
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# Check for critical tables
TABLES=("options_quotes" "latest_gex")
for table in "${TABLES[@]}"; do
    TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
    TABLE_OUT=""
    if PGPASSWORD="$DB_PASSWORD" psql -U gex_user -d gex_db -h localhost -t -c "\dt $table" 2>/dev/null | grep -q "$table"; then
        TABLE_OUT=`echo -e "  ${GREEN}✓${NC} Table exists: $table"`
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
    else
        TABLE_OUT=`echo -e "  ${YELLOW}⚠${NC} Table not found: $table (may not be created yet)"`
        WARNING_CHECKS=$((WARNING_CHECKS + 1))
    fi
    log "${TABLE_OUT}"
done
log ""

# Section 4: Recent Ingestion Logs
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
log "4. Ingestion Service Logs (last 10 lines)"
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
sudo journalctl -u gex-ingestion -n 10 --no-pager
log ""

# Section 5: Recent Scheduler Logs
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
log "5. Scheduler Service Logs (last 10 lines)"
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
sudo journalctl -u gex-scheduler -n 10 --no-pager
log ""

# Section 6: Data Flow Check
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
log "6. Recent Data Flow Check (last 10 minutes)"
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))

# Check if options_quotes table exists first
if PGPASSWORD="$DB_PASSWORD" psql -U gex_user -d gex_db -h localhost -t -c "\dt options_quotes" 2>/dev/null | grep -q "options_quotes"; then
    DATA_CHECK=$(PGPASSWORD="$DB_PASSWORD" psql -U gex_user -d gex_db -h localhost -t -c "SELECT COUNT(*) FROM options_quotes WHERE timestamp > NOW() - INTERVAL '10 minutes';" 2>/dev/null | xargs)

    if [ -n "$DATA_CHECK" ] && [ "$DATA_CHECK" -gt 0 ]; then
        DATA_FOUND=`echo -e "  ${GREEN}✓${NC} Recent data found: $DATA_CHECK rows in last 10 minutes"`
	log "${DATA_FOUND}"
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
    else
        NO_DATA=`echo -e "  ${YELLOW}⚠${NC} No recent data (0 rows in last 10 minutes)"`
	log "${NO_DATA}"
        log "     This is normal if services just started or markets are closed"
        WARNING_CHECKS=$((WARNING_CHECKS + 1))
    fi
else
    NOT_CREATED=`echo -e "  ${YELLOW}⚠${NC} options_quotes table not yet created"`
    log "${NOT_CREATED}"
    WARNING_CHECKS=$((WARNING_CHECKS + 1))
fi
log ""

# Section 7: GEX Calculations
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
log "7. Latest GEX Calculations"
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))

if PGPASSWORD="$DB_PASSWORD" psql -U gex_user -d gex_db -h localhost -t -c "\dt latest_gex" 2>/dev/null | grep -q "latest_gex"; then
    GEX_COUNT=$(PGPASSWORD="$DB_PASSWORD" psql -U gex_user -d gex_db -h localhost -t -c "SELECT COUNT(*) FROM latest_gex;" 2>/dev/null | xargs)

    if [ -n "$GEX_COUNT" ] && [ "$GEX_COUNT" -gt 0 ]; then
        echo -e "  ${GREEN}✓${NC} GEX calculations found: $GEX_COUNT rows"
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
        log ""
        log "  Sample GEX data:"
        PGPASSWORD="$DB_PASSWORD" psql -U gex_user -d gex_db -h localhost -c "SELECT * FROM latest_gex LIMIT 5;" 2>/dev/null || echo "     (no data yet)"
    else
        NO_GEX=`echo -e "  ${YELLOW}⚠${NC} No GEX calculations yet"`
	log "${NO_GEX}"
        log "     This is normal if services just started"
        WARNING_CHECKS=$((WARNING_CHECKS + 1))
    fi
else
    echo -e "  ${YELLOW}⚠${NC} latest_gex table not yet created"
    WARNING_CHECKS=$((WARNING_CHECKS + 1))
fi
log ""

# Section 8: System Resources
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
log "8. System Resource Usage"
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# Disk usage
DISK_USAGE=$(df -h / | tail -1 | awk '{print $5}' | sed 's/%//')
DISK_INFO=$(df -h / | tail -1)
log "  Disk Usage:"
log "     $DISK_INFO"
DU_OUT=""
if [ "$DISK_USAGE" -lt 80 ]; then
    DU_OUT=`echo -e "     ${GREEN}✓${NC} Disk usage OK (${DISK_USAGE}%)"`
elif [ "$DISK_USAGE" -lt 90 ]; then
    DU_OUT=`echo -e "     ${YELLOW}⚠${NC} Disk usage warning (${DISK_USAGE}%)"`
else
    DU_OUT=`echo -e "     ${RED}✗${NC} Disk usage critical (${DISK_USAGE}%)"`
fi
log "${DU_OUT}"
log ""

# Memory usage
MEM_INFO=$(free -h | grep Mem)
MEM_PERCENT=$(free | grep Mem | awk '{printf("%.0f", $3/$2 * 100)}')
log "  Memory Usage:"
log "     $MEM_INFO"
MEM_OUT=""
if [ "$MEM_PERCENT" -lt 80 ]; then
    MEM_OUT=`echo -e "     ${GREEN}✓${NC} Memory usage OK (${MEM_PERCENT}%)"`
elif [ "$MEM_PERCENT" -lt 90 ]; then
    MEM_OUT=`echo -e "     ${YELLOW}⚠${NC} Memory usage warning (${MEM_PERCENT}%)"`
else
    MEM_OUT=`echo -e "     ${RED}✗${NC} Memory usage high (${MEM_PERCENT}%)"`
fi
log "${MEM_OUT}"
log ""

# Section 9: Security Status
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
log "9. Security Configuration"
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# UFW status
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
FW_OUT=""
if sudo ufw status | grep -q "Status: active"; then
    FW_OUT=`echo -e "  ${GREEN}✓${NC} Firewall (UFW) is active"`
    PASSED_CHECKS=$((PASSED_CHECKS + 1))
else
    FW_OUT=`echo -e "  ${RED}✗${NC} Firewall (UFW) is not active"`
    FAILED_CHECKS=$((FAILED_CHECKS + 1))
fi
log "${FW_OUT}"

# SSH configuration
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
SSH_OUT=""
if grep -q "^PermitRootLogin no" /etc/ssh/sshd_config && grep -q "^PasswordAuthentication no" /etc/ssh/sshd_config; then
    SSH_OUT=`echo -e "  ${GREEN}✓${NC} SSH hardening configured"`
    PASSED_CHECKS=$((PASSED_CHECKS + 1))
else
    SSH_OUT=`echo -e "  ${YELLOW}⚠${NC} SSH hardening may not be fully configured"`
    WARNING_CHECKS=$((WARNING_CHECKS + 1))
fi

# Backup configuration
TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
BKUP_OUT=""
if crontab -l 2>/dev/null | grep -q "backup-gex-db.sh"; then
    BKUP_OUT=`echo -e "  ${GREEN}✓${NC} Automated backups configured"`
    PASSED_CHECKS=$((PASSED_CHECKS + 1))
else
    BKUP_OUT=`echo -e "  ${YELLOW}⚠${NC} Automated backups not configured"`
    WARNING_CHECKS=$((WARNING_CHECKS + 1))
fi
log "${BKUP_OUT}"
log ""

# Final Summary
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
log "VALIDATION SUMMARY"
log "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
log ""
log "Total Checks: $TOTAL_CHECKS"
CHECKS=`echo -e "${GREEN}Passed: $PASSED_CHECKS${NC}\n${YELLOW}Warnings: $WARNING_CHECKS${NC}\n${RED}Failed: $FAILED_CHECKS${NC}"`
log "${CHECKS}"
log ""

if [ "$FAILED_CHECKS" -eq 0 ]; then
    PASSED=`echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n${GREEN}✓ Deployment validation PASSED!${NC}\n${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    log "${PASSED}"
    log ""
    log "ZeroGEX platform is ready for production!"

    if [ "$WARNING_CHECKS" -gt 0 ]; then
        log ""
        WARNINGS=`echo -e "${YELLOW}Note: Some warnings were detected. These are typically normal\nfor a fresh deployment or when markets are closed.${NC}"`
        log "${WARNINGS}"
    fi
else
    FAILED=`echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n${RED}✗ Deployment validation FAILED!${NC}\n${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"`
    log "${FAILED}"
    log ""
    log "Please review the failed checks above and resolve issues."
    log "Check service logs for more details:"
    log "  sudo journalctl -u gex-ingestion -f"
    log "  sudo journalctl -u gex-scheduler -f"
    exit 1
fi

log ""
log "Deployment validation complete!"
log ""
