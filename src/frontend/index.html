<!DOCTYPE html>
<html>
<head>
    <title>ZeroGEXâ„¢ | Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
        }
        .grid { display: grid; gap: 24px; margin-bottom: 24px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .card {
            background: #1e293b;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #334155;
        }
        .card h3 {
            color: #94a3b8;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 16px;
            letter-spacing: 0.05em;
        }
        .chart-container {
            position: relative;
            height: 350px;
        }
        .metric-label {
            color: #94a3b8;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-weight: 600;
        }
        .metric-value {
            font-size: 36px;
            font-weight: 700;
            color: #e2e8f0;
        }
        .metric-large {
            font-size: 48px;
            font-weight: 700;
            line-height: 1;
        }
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        .neutral { color: #60a5fa; }
    </style>
</head>
<body>
    <div id="nav-placeholder"></div>

    <div class="container">
        <!-- Top Priority Metrics -->
        <div class="grid grid-4">
            <div class="card">
                <div class="metric-label">SPY Price</div>
                <div id="spyPrice" class="metric-large neutral">--</div>
                <div id="spyChange" style="margin-top: 8px; font-size: 14px;">--</div>
            </div>

            <div class="card">
                <div class="metric-label">Net GEX</div>
                <div id="netGEX" class="metric-large">--</div>
                <div class="metric-label" style="margin-top: 8px;">Gamma Regime</div>
            </div>

            <div class="card">
                <div class="metric-label">Put/Call Ratio</div>
                <div id="putCallRatio" class="metric-large neutral">--</div>
                <div class="metric-label" style="margin-top: 8px;">Open Interest</div>
            </div>

            <div class="card">
                <div class="metric-label">Market Bias</div>
                <div id="marketBias" class="metric-large neutral">--</div>
                <div id="biasScore" class="metric-label" style="margin-top: 8px;">--</div>
            </div>
        </div>

        <!-- Key Charts -->
        <div class="grid grid-2">
            <div class="card">
                <h3>Net Gamma Exposure - 24 Hours</h3>
                <div class="chart-container">
                    <canvas id="gexChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>SPY Price Action - 24 Hours</h3>
                <div class="chart-container">
                    <canvas id="spyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-2">
            <div class="card">
                <h3>Put/Call Ratio - 24 Hours</h3>
                <div class="chart-container">
                    <canvas id="putCallChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>Current Gamma by Strike</h3>
                <div class="chart-container">
                    <canvas id="strikeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load shared navigation
        fetch('/_navigation.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('nav-placeholder').innerHTML = html;
            })
            .catch(error => console.error('Error loading navigation:', error));

        let charts = {};

        function calculateMarketBias(data) {
            let score = 0;
            if (data.net_gex > 0) {
                score += Math.min(30, (data.net_gex / 1e9) * 30);
            } else {
                score += Math.max(-30, (data.net_gex / 1e9) * 30);
            }
            if (data.gamma_flip_point) {
                const flipDistance = ((data.underlying_price - data.gamma_flip_point) / data.underlying_price) * 100;
                score += Math.max(-25, Math.min(25, flipDistance * 5));
            }
            score += Math.max(-20, Math.min(20, (1 - data.put_call_ratio) * 20));
            const gammaDistance = ((data.underlying_price - data.max_gamma_strike) / data.underlying_price) * 100;
            score += -Math.max(-15, Math.min(15, gammaDistance * 3));

            let bias, cssClass;
            if (score > 25) {
                bias = 'BULLISH';
                cssClass = 'positive';
            } else if (score < -25) {
                bias = 'BEARISH';
                cssClass = 'negative';
            } else {
                bias = 'NEUTRAL';
                cssClass = 'neutral';
            }
            return { bias, score: score.toFixed(0), cssClass };
        }

        async function updateMetrics() {
            try {
                const gexResponse = await fetch('/api/gex/current');
                const gexData = await gexResponse.json();

                const spyResponse = await fetch('/api/spy-change');
                const spyData = await spyResponse.json();

                document.getElementById('spyPrice').textContent = '$' + spyData.current_price.toFixed(2);
                const changeEl = document.getElementById('spyChange');
                const changeSymbol = spyData.change >= 0 ? '+' : '';
                changeEl.textContent = changeSymbol + '$' + spyData.change.toFixed(2) + ' (' + changeSymbol + spyData.percent_change.toFixed(2) + '%)';
                changeEl.className = spyData.change >= 0 ? 'positive' : 'negative';

                const netGexEl = document.getElementById('netGEX');
                netGexEl.textContent = (gexData.net_gex >= 0 ? '+' : '') + (gexData.net_gex / 1e6).toFixed(1) + 'M';
                netGexEl.className = 'metric-large ' + (gexData.net_gex >= 0 ? 'positive' : 'negative');

                document.getElementById('putCallRatio').textContent = gexData.put_call_ratio.toFixed(2);

                const biasResult = calculateMarketBias(gexData);
                const biasEl = document.getElementById('marketBias');
                biasEl.textContent = biasResult.bias;
                biasEl.className = 'metric-large ' + biasResult.cssClass;
                document.getElementById('biasScore').textContent = 'Score: ' + biasResult.score + '/100';

            } catch (error) {
                console.error('Error updating metrics:', error);
            }
        }

        async function updateCharts() {
            try {
                const gexHistResponse = await fetch('/api/gex/history');
                const gexHistData = await gexHistResponse.json();

                if (charts.gex) charts.gex.destroy();
                const gexCtx = document.getElementById('gexChart');
                charts.gex = new Chart(gexCtx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Net GEX',
                            data: gexHistData.map(d => ({
                                x: new Date(d.timestamp).getTime(),
                                y: d.net_gex_millions
                            })),
                            borderColor: '#60a5fa',
                            backgroundColor: 'rgba(96, 165, 250, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'hour', displayFormats: { hour: 'HH:mm' }},
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            },
                            y: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            }
                        },
                        plugins: { legend: { display: false }}
                    }
                });

                const spyHistResponse = await fetch('/api/market/SPY/history');
                const spyHistData = await spyHistResponse.json();

                if (charts.spy) charts.spy.destroy();
                const spyCtx = document.getElementById('spyChart');
                charts.spy = new Chart(spyCtx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'SPY Price',
                            data: spyHistData.map(d => ({
                                x: new Date(d.timestamp).getTime(),
                                y: d.close
                            })),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'hour', displayFormats: { hour: 'HH:mm' }},
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            },
                            y: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            }
                        },
                        plugins: { legend: { display: false }}
                    }
                });

                const pcResponse = await fetch('/api/gex/put-call-history');
                const pcData = await pcResponse.json();

                if (charts.putCall) charts.putCall.destroy();
                const pcCtx = document.getElementById('putCallChart');
                charts.putCall = new Chart(pcCtx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Put/Call Ratio',
                            data: pcData.map(d => ({
                                x: new Date(d.timestamp).getTime(),
                                y: d.put_call_ratio
                            })),
                            borderColor: '#a855f7',
                            backgroundColor: 'rgba(168, 85, 247, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'hour', displayFormats: { hour: 'HH:mm' }},
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            },
                            y: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            }
                        },
                        plugins: { legend: { display: false }}
                    }
                });

                const strikeResponse = await fetch('/api/gex/strike-profile');
                const strikeData = await strikeResponse.json();

                if (charts.strike) charts.strike.destroy();
                const strikeCtx = document.getElementById('strikeChart');
                charts.strike = new Chart(strikeCtx, {
                    type: 'bar',
                    data: {
                        labels: strikeData.strikes.map(s => s.strike),
                        datasets: [
                            {
                                label: 'Call Gamma',
                                data: strikeData.strikes.map(s => s.call_gamma_millions),
                                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                                stack: 'stack0'
                            },
                            {
                                label: 'Put Gamma',
                                data: strikeData.strikes.map(s => -s.put_gamma_millions),
                                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                                stack: 'stack0'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            },
                            y: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#334155' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#e2e8f0' }}
                        }
                    }
                });

            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

        updateMetrics();
        updateCharts();

        setInterval(updateMetrics, 10000);
        setInterval(updateCharts, 30000);
    </script>
</body>
</html>
