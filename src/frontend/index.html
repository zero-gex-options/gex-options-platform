<!DOCTYPE html>
<html>
<head>
    <title>ZeroGEX™ | Dashboard</title>
    <link rel="icon" href="/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <script src="/navigation.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #2a2628;
            color: #f2f2f2;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
        }
        .grid { display: grid; gap: 24px; margin-bottom: 24px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .card {
            background: #423d3f;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #968f92;
        }
        .card h3 {
            color: #968f92;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 16px;
            letter-spacing: 0.05em;
        }
        .chart-container {
            position: relative;
            height: 350px;
        }
        .metric-label {
            color: #968f92;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .metric-value {
            font-size: 36px;
            font-weight: 700;
            color: #f2f2f2;
        }
        .metric-large {
            font-size: 48px;
            font-weight: 700;
            line-height: 1;
        }
        .positive { color: #10b981; }
        .negative { color: #f45854; }
        .neutral { color: #f2f2f2; }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            opacity: 0;
            width: 300px;
            background-color: #423d3f;
            color: #f2f2f2;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            top: 100%;
            left: 50%;
            margin-left: -150px;
            margin-top: 10px;
            transition: opacity 0.3s;
            border: 1px solid #968f92;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            font-size: 12px;
            line-height: 1.5;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent #423d3f transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .info-icon {
            cursor: help;
            color: #968f92;
            font-size: 14px;
        }
        .footer {
            background: #423d3f;
            border-top: 1px solid #968f92;
            padding: 24px 32px;
            margin-top: 48px;
        }
        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            text-align: center;
        }
        .footer-logo {
            height: 400px;
            width: auto;
            margin-bottom: 12px;
            opacity: 0.8;
        }
        .footer-text {
            color: #968f92;
            font-size: 13px;
        }
        .footer-tagline {
            color: #968f92;
            font-size: 12px;
            margin-top: 8px;
        }

        /* Light mode styles */
        body.light-mode {
            background: #f2f2f2;
            color: #423d3f;
        }
        body.light-mode .card {
            background: #ffffff;
            border: 1px solid #968f92;
        }
        body.light-mode .card h3 {
            color: #423d3f;
        }
        body.light-mode .metric-label {
            color: #423d3f;
        }
        body.light-mode .metric-value,
        body.light-mode .metric-large,
        body.light-mode .metric-medium {
            color: #423d3f;
        }
        body.light-mode .neutral {
            color: #423d3f;
        }
        body.light-mode .tooltip .tooltiptext {
            background-color: #ffffff;
            color: #423d3f;
            border: 1px solid #968f92;
        }
        body.light-mode .tooltip .tooltiptext::after {
            border-color: transparent transparent #ffffff transparent;
        }
        body.light-mode .info-icon {
            color: #423d3f;
        }
        body.light-mode .loading {
            color: #423d3f;
        }
        body.light-mode .level-item,
        body.light-mode .regime-timeline-item,
        body.light-mode .metric-box,
        body.light-mode .feature-box {
            background: #f2f2f2;
            border: 1px solid #968f92;
        }
        body.light-mode .regime-time,
        body.light-mode .regime-price,
        body.light-mode .level-gamma {
            color: #423d3f;
        }
        body.light-mode .footer {
            background: #f2f2f2;
            border-top: 1px solid #968f92;
        }
        body.light-mode .footer-text,
        body.light-mode .footer-tagline {
            color: #423d3f;
        }
        body.light-mode .spy-banner {
            background: linear-gradient(135deg, #ffffff 0%, #f2f2f2 100%);
            border: 1px solid #968f92;
        }
        body.light-mode .banner-timestamp {
            color: #423d3f;
        }
        body.light-mode .market-status-badge {
            color: #423d3f;
        }
    </style>
</head>
<body>
    <div id="nav-placeholder"></div>

    <div class="container">
        <!-- Top Priority Metrics -->
        <div class="grid grid-4">
            <div class="card">
                <div class="metric-label">
                    SPY Price
                    <span class="tooltip">
                        <span class="info-icon">ℹ️</span>
                        <span class="tooltiptext">
                            <strong>Current SPY Price</strong><br><br>
                            Real-time price of the S&P 500 ETF with daily change. Green indicates gains, red indicates losses.
                        </span>
                    </span>
                </div>
                <div id="spyPrice" class="metric-large neutral">--</div>
                <div id="spyChange" style="margin-top: 8px; font-size: 14px;">--</div>
            </div>

            <div class="card">
                <div class="metric-label">
                    Net GEX
                    <span class="tooltip">
                        <span class="info-icon">ℹ️</span>
                        <span class="tooltiptext">
                            <strong>Net Gamma Exposure</strong><br><br>
                            <strong>Positive (Green):</strong> Dealers are long gamma, creating stabilizing forces. Bullish bias.<br><br>
                            <strong>Negative (Red):</strong> Dealers are short gamma, amplifying moves. Bearish bias.
                        </span>
                    </span>
                </div>
                <div id="netGEX" class="metric-large">--</div>
                <div class="metric-label" style="margin-top: 8px;">Gamma Regime</div>
            </div>

            <div class="card">
                <div class="metric-label">
                    Put/Call Ratio
                    <span class="tooltip">
                        <span class="info-icon">ℹ️</span>
                        <span class="tooltiptext">
                            <strong>Put/Call Open Interest Ratio</strong><br><br>
                            <strong>High (>1.0):</strong> More puts than calls - hedging/fear. Bearish tilt.<br>
                            <strong>Low (<0.7):</strong> More calls than puts. Bullish tilt.<br>
                            <strong>~0.7-1.0:</strong> Balanced.
                        </span>
                    </span>
                </div>
                <div id="putCallRatio" class="metric-large neutral">--</div>
                <div class="metric-label" style="margin-top: 8px;">Open Interest</div>
            </div>

            <div class="card">
                <div class="metric-label">
                    Market Bias
                    <span class="tooltip">
                        <span class="info-icon">ℹ️</span>
                        <span class="tooltiptext">
                            <strong>Composite Market Bias</strong><br><br>
                            Score from -100 to +100 based on Net GEX, Gamma Flip Point, Put/Call Ratio, and Max Gamma Strike.<br><br>
                            <strong>Bullish (>25):</strong> Favorable conditions<br>
                            <strong>Neutral (-25 to 25):</strong> Mixed signals<br>
                            <strong>Bearish (<-25):</strong> Unfavorable conditions
                        </span>
                    </span>
                </div>
                <div id="marketBias" class="metric-large neutral">--</div>
                <div id="biasScore" class="metric-label" style="margin-top: 8px;">--</div>
            </div>
        </div>

        <!-- Key Charts -->
        <div class="grid grid-2">
            <div class="card">
                <h3>Net Gamma Exposure - 24 Hours</h3>
                <div class="chart-container">
                    <canvas id="gexChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>SPY Price Action - 24 Hours</h3>
                <div class="chart-container">
                    <canvas id="spyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-2">
            <div class="card">
                <h3>Put/Call Ratio - 24 Hours</h3>
                <div class="chart-container">
                    <canvas id="putCallChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>Current Gamma by Strike</h3>
                <div class="chart-container">
                    <canvas id="strikeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="footer-content">
            <img src="/logo_full" alt="ZeroGEX" class="footer-logo">
            <div class="footer-text"><i>Trading involves substantial risk. Past performance is not indicative of future results.</i></div>
            <div class="footer-tagline">© 2026 ZeroGEX, LLC. All rights reserved.</div>
        </div>
    </div>

    <script>
        // Load shared navigation
        fetch('/_navigation.html')
            .then(response => response.text())
            .then(html => {
                document.getElementById('nav-placeholder').innerHTML = html;
                if (typeof initializeNavigation === 'function') {
                    initializeNavigation();
                }
            })
            .catch(error => console.error('Error loading navigation:', error));

        let charts = {};

        function calculateMarketBias(data) {
            let score = 0;
            if (data.net_gex > 0) {
                score += Math.min(30, (data.net_gex / 1e9) * 30);
            } else {
                score += Math.max(-30, (data.net_gex / 1e9) * 30);
            }
            if (data.gamma_flip_point) {
                const flipDistance = ((data.underlying_price - data.gamma_flip_point) / data.underlying_price) * 100;
                score += Math.max(-25, Math.min(25, flipDistance * 5));
            }
            score += Math.max(-20, Math.min(20, (1 - data.put_call_ratio) * 20));
            const gammaDistance = ((data.underlying_price - data.max_gamma_strike) / data.underlying_price) * 100;
            score += -Math.max(-15, Math.min(15, gammaDistance * 3));

            let bias, cssClass;
            if (score > 25) {
                bias = 'BULLISH';
                cssClass = 'positive';
            } else if (score < -25) {
                bias = 'BEARISH';
                cssClass = 'negative';
            } else {
                bias = 'NEUTRAL';
                cssClass = 'neutral';
            }
            return { bias, score: score.toFixed(0), cssClass };
        }

        async function updateMetrics() {
            try {
                const gexResponse = await fetch('/api/gex/current');
                const gexData = await gexResponse.json();

                const spyResponse = await fetch('/api/spy-change');
                const spyData = await spyResponse.json();

                document.getElementById('spyPrice').textContent = '$' + spyData.current_price.toFixed(2);
                const changeEl = document.getElementById('spyChange');
                const changeSymbol = spyData.change >= 0 ? '+' : '';
                changeEl.textContent = changeSymbol + '$' + spyData.change.toFixed(2) + ' (' + changeSymbol + spyData.percent_change.toFixed(2) + '%)';
                changeEl.className = spyData.change >= 0 ? 'positive' : 'negative';

                const netGexEl = document.getElementById('netGEX');
                netGexEl.textContent = (gexData.net_gex >= 0 ? '+' : '') + (gexData.net_gex / 1e6).toFixed(1) + 'M';
                netGexEl.className = 'metric-large ' + (gexData.net_gex >= 0 ? 'positive' : 'negative');

                document.getElementById('putCallRatio').textContent = gexData.put_call_ratio.toFixed(2);

                const biasResult = calculateMarketBias(gexData);
                const biasEl = document.getElementById('marketBias');
                biasEl.textContent = biasResult.bias;
                biasEl.className = 'metric-large ' + biasResult.cssClass;
                document.getElementById('biasScore').textContent = 'Score: ' + biasResult.score + '/100';

            } catch (error) {
                console.error('Error updating metrics:', error);
            }
        }

        async function updateCharts() {
            try {
                const gexHistResponse = await fetch('/api/gex/history');
                const gexHistData = await gexHistResponse.json();

                if (charts.gex) charts.gex.destroy();
                const gexCtx = document.getElementById('gexChart');
                charts.gex = new Chart(gexCtx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Net GEX',
                            data: gexHistData.map(d => ({
                                x: new Date(d.timestamp).getTime(),
                                y: d.net_gex_millions
                            })),
                            borderColor: '#f45854',
                            backgroundColor: 'rgba(244, 88, 84, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'hour', displayFormats: { hour: 'HH:mm' }},
                                ticks: { color: '#968f92' },
                                grid: { color: '#968f92' }
                            },
                            y: {
                                ticks: { color: '#968f92' },
                                grid: { color: '#968f92' }
                            }
                        },
                        plugins: { legend: { display: false }}
                    }
                });

                const spyHistResponse = await fetch('/api/market/SPY/history');
                const spyHistData = await spyHistResponse.json();

                if (charts.spy) charts.spy.destroy();
                const spyCtx = document.getElementById('spyChart');
                charts.spy = new Chart(spyCtx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'SPY Price',
                            data: spyHistData.map(d => ({
                                x: new Date(d.timestamp).getTime(),
                                y: d.close
                            })),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'hour', displayFormats: { hour: 'HH:mm' }},
                                ticks: { color: '#968f92' },
                                grid: { color: '#968f92' }
                            },
                            y: {
                                ticks: { color: '#968f92' },
                                grid: { color: '#968f92' }
                            }
                        },
                        plugins: { legend: { display: false }}
                    }
                });

                const pcResponse = await fetch('/api/gex/put-call-history');
                const pcData = await pcResponse.json();

                if (charts.putCall) charts.putCall.destroy();
                const pcCtx = document.getElementById('putCallChart');
                charts.putCall = new Chart(pcCtx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Put/Call Ratio',
                            data: pcData.map(d => ({
                                x: new Date(d.timestamp).getTime(),
                                y: d.put_call_ratio
                            })),
                            borderColor: '#968f92',
                            backgroundColor: 'rgba(150, 143, 146, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'hour', displayFormats: { hour: 'HH:mm' }},
                                ticks: { color: '#968f92' },
                                grid: { color: '#968f92' }
                            },
                            y: {
                                ticks: { color: '#968f92' },
                                grid: { color: '#968f92' }
                            }
                        },
                        plugins: { legend: { display: false }}
                    }
                });

                const strikeResponse = await fetch('/api/gex/strike-profile');
                const strikeData = await strikeResponse.json();

                if (charts.strike) charts.strike.destroy();
                const strikeCtx = document.getElementById('strikeChart');
                charts.strike = new Chart(strikeCtx, {
                    type: 'bar',
                    data: {
                        labels: strikeData.strikes.map(s => s.strike),
                        datasets: [
                            {
                                label: 'Call Gamma',
                                data: strikeData.strikes.map(s => s.call_gamma_millions),
                                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                                stack: 'stack0'
                            },
                            {
                                label: 'Put Gamma',
                                data: strikeData.strikes.map(s => -s.put_gamma_millions),
                                backgroundColor: 'rgba(244, 88, 84, 0.7)',
                                stack: 'stack0'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                ticks: { color: '#968f92' },
                                grid: { color: '#968f92' }
                            },
                            y: {
                                ticks: { color: '#968f92' },
                                grid: { color: '#968f92' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#f2f2f2' }}
                        }
                    }
                });

            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

        updateMetrics();
        updateCharts();

        setInterval(updateMetrics, 10000);
        setInterval(updateCharts, 30000);
    </script>

    <!-- Last Updated Footer -->
    <div style="text-align: center; padding: 24px 0; color: #968f92; font-size: 12px; border-top: 1px solid #968f92; margin-top: 32px;">
        <div id="lastUpdated">Last updated: --</div>
    </div>

    <script>
        // Update timestamp function
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent =
                'Last updated: ' + now.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZone: 'America/New_York'
                }) + ' ET';
        }

        // Initial update
        updateTimestamp();

        // Update every second
        setInterval(updateTimestamp, 1000);
    </script>
</body>
</html>
